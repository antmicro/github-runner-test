on: [push]

name: test

jobs:
  simple-job:
    container: debian:bullseye
    runs-on: [self-hosted, Linux, X64]
    env:
      GHA_PREEMPTIBLE: "false"
    steps:
    - uses: actions/checkout@v2
      with:
          submodules: recursive
    - run: "apt -qqy update && apt -qqy install docker.io build-essential wget libyajl-dev"
    - run: "mkdir -p crun && wget -qO- https://github.com/containers/crun/archive/refs/tags/1.7.tar.gz | tar xvz --strip-components=1 -C ./crun"
    - run: |
        cd crun
        ./autogen.sh
        ./configure --disable-caps --disable-seccomp --disable-systemd --disable-criu
        patch -p1 < ../dont-set-cgroup-limits.patch
        make
        make install"
    - run: "cp daemon.json /etc/docker/daemon.json"
    - name: Run steps in Docker
      run: |
        dockerd -s vfs &
        docker run -t centos cat /etc/os-release
        kill /var/run/docker.pid
