on: [push]

name: test

jobs:
  simple-job:
    container: debian:bullseye
    runs-on: [self-hosted, Linux, X64]
    env:
      GHA_PREEMPTIBLE: "false"
    steps:
    - uses: actions/checkout@v2
      with:
          submodules: recursive
    - run: "apt -qqy update && apt -qqy --no-install-recommends install docker.io cgroupfs-mount crun fuse-overlayfs pigz ca-certificates iproute2"
    - run: cgroupfs-mount
    - run: ip netns add test
    - name: Run steps in Docker
      run: |
        dockerd -s fuse-overlayfs --add-runtime=crun=/usr/bin/crun --default-runtime=crun > dockerd.log 2>&1 &
        while ! test -S /var/run/docker.sock; do echo "Waiting for Docker..." && sleep 1; done; docker info
        trap "kill $(cat /var/run/docker.pid)" EXIT
        docker run -t centos cat /etc/os-release

    - uses: actions/upload-artifact@v3
      with:
        name: plots 
        path: |
          '**/plot_*.svg'
          'dockerd.log'
